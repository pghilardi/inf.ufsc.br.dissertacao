\chapter{Estudo de Caso}\label{case_study}

Este capítulo apresenta dois estudos de caso para verificar a aplicabilidade da abordagem proposta na modelagem de interesses de uma aplicação. Os
estudos de caso são baseados no sistema para gerenciamento de hotel proposto por Jacobson \cite{Jacobson:2004:ASD:1062430}. Este exemplo permite a
modelagem de funcionalidades importantes de aspectos e foi utilizado para validar a abordagem de Jacobson. Os casos de uso tratados pelos
estudos de caso são: reserva de quartos, tratamento de uma lista de espera para clientes, registro de mensagens, check-out de clientes e o acúmulo de
pontos em um programa de fidelidade. 

Os estudos de caso tratam da composição automática de modelos comportamentais, isto é, de diagramas de sequência. O algoritmo de composição utiliza
estereótipos e valores rotulados dos diagramas de classe, mas apenas a troca de mensagens é apresentada neste capítulo. Diagramas de sequência são 
utilizados para representar o comportamento dos interesses núcleo e entrecortantes, usando o perfil UML e o processo proposto por esta abordagem. A
modelagem de interesses usando diagramas comportamentais da UML fornece subsídios para realizar a troca de visões, a qual permite uma melhor compreensão 
de aplicações orientadas a aspectos, visualizando o efeito dos aspectos no sistema. 

A próxima seção apresenta o primeiro estudo de caso, que trata da composição de dois interesses entrecortantes (registro de mensagens e adição de
clientes em uma lista de espera) com um interesse núcleo para reserva de quartos. O segundo estudo de caso especifica a composição de um interesse
para acúmulo de pontos em um programa de fidelidade e o interesse de registro de mensagens com um interesse núcleo para check-out de clientes.

\section{Estudo de Caso: Reserva de Quarto, Registro de Mensagens e Lista de Espera}

O primeiro diagrama de sequência é o que representa a troca de mensagens do interesse para reserva de quartos. O diagrama pode ser visualizado na
figura \ref{fig:case_study_behavioral_reserve_room}. Para realizar uma reserva de quarto, primeiramente realiza-se uma chamada ao método
\textit{makeReservation()} da classe \textit{ReserveRoomHandler} que é responsável por iniciar a reserva. Após esta chamada, executa-se o método
para verificar se o quarto está disponível. Se o quarto não estiver disponível, uma exceção é lançada no método \textit{updateAvailability()}, caso
contrário, a reserva é realizada e o cliente recebe um código de confirmação.

  \begin{figure}[!b]
	\centering
	\includegraphics{img/case_study_behavioral_reserve_room.png}
	\caption{Diagrama de Sequência: Reserva de Quarto.}\label{fig:case_study_behavioral_reserve_room}
  \end{figure}
  
Os outros interesses modelados são interesses entrecortantes que contém pontos de corte e avisos. Este tipo de interesse estende os interesses
núcleos adicionando novos comportamentos ao sistema. Os pontos de corte capturam quais pontos do sistema serão estendidos e os avisos especificam o
comportamento que deverá ser executado nestes pontos.

O interesse entrecortante para registro de mensagem contabiliza o número de requisições a um quarto. Para realizar este objetivo, define-se um ponto
de corte que captura qualquer chamada a classes do tipo \textit{Room}. Este ponto de corte é modelado usando o diagrama de máquina de estados da UML e pode ser visualizado na figura
\ref{fig:case_study_behavioral_pointcut_log}. Com o ponto de corte especificado, cria-se o diagrama de sequência para representar a troca de mensagens
entre objetos para realização do registro de chamadas. O diagrama pode ser visualizado na figura \ref{fig:case_study_behavioral_log} e contém o
aspecto \textit{LogAspect} associado a primeira linha de vida do diagrama. De acordo com a abordagem proposta, um aspecto no diagrama de sequência
deve ter uma invariante de estado associada, a qual é o gatilho para começar a executar a sequência de mensagens do diagrama. No exemplo em questão,
a invariante de estado \textit{RoomCall} está associada ao aspecto \textit{LogAspect} e referencia o ponto de corte definido previamente no diagrama
de máquina de estados. A semântica é que a sequência de mensagens só será executada quando o ponto de corte for satisfeito. A mensagem a ser executada
é uma chamada ao método \textit{log()} da classe \textit{Logger}. É importante observar o tipo de aviso, que é
definido como um valor rotulado na invariante de estado. O valor rotulado não está sendo mostrado no diagrama de sequência por configuração de
visualização, já que por padrão os valores rotulados não são exibidos. A abordagem proposta suporta três tipos de aviso: antes, durante ou depois. Neste caso, o
tipo de aviso é depois, o que significa que o comportamento de registro de mensagens somente executará após a chamada a qualquer método da classe
\textit{Room}. O diagrama de sequência contém um fragmento combinado do tipo opcional, o qual define que o registro de mensagens executará se a
aplicação não estiver congelada. Uma aplicação está congelada quando está executando diretamente para o usuário e é considerada congelada no ambiente
de desenvolvimento.

  \begin{figure}[tb]
	\centering
	\includegraphics{img/case_study_behavioral_pointcut_log.png}
	\caption{Ponto de Corte: Registro de Mensagens.}\label{fig:case_study_behavioral_pointcut_log}
  \end{figure}
  
  \begin{figure}[tb]
	\centering
	\includegraphics{img/case_study_behavioral_log.png}
	\caption{Aviso: Registro de Mensagens.}\label{fig:case_study_behavioral_log}
  \end{figure}

O requisito para criação de uma lista de espera para clientes também é um interesse entrecortante. Este interesse adiciona um cliente a uma lista de
espera quando um quarto não está disponível. Para realizar isto, é necessário um ponto de corte que captura a tentativa de um cliente reservar um
quarto sem sucesso, porque o quarto está indisponível. A figura \ref{fig:case_study_behavioral_pointcut_waiting_list} representa um ponto de corte
para capturar as chamadas ao método \textit{updateAvailability()} da classe \textit{Room}, lançando a exceção \textit{NoRoomsAvailable}. Além da
definição de um ponto de corte, é necessário definir o comportamento de como um cliente é adicionado a lista de espera. O comportamento é modelado no
diagrama de sequência da figura \ref{fig:case_study_behavioral_waiting_list}. O diagrama tem o aspecto \textit{WaitingListAspect} como o objeto
associado a primeira linha de vida e uma sequência de mensagens para serem executadas quando o sistema lança uma exceção de quarto indisponível. Estas
mensagens são executadas depois do tratamento de exceção, pois o valor rotulado que define o tipo do aviso na invariante de estado é do tipo depois.
Novamente, o valor rotulado não é exibido no diagrama de sequência para não poluir o diagrama.

  \begin{figure}[tb]
	\centering
	\includegraphics[scale=0.8]{img/case_study_behavioral_pointcut_waiting_list.png}
	\caption{Ponto de Corte: Controle de uma Lista de Espera.}\label{fig:case_study_behavioral_pointcut_waiting_list}
  \end{figure}
  
  \begin{figure}
	\centering
	\includegraphics{img/case_study_behavioral_waiting_list.png}
	\caption{Aviso: Controle de uma Lista de Espera.}\label{fig:case_study_behavioral_waiting_list}
  \end{figure}
  
Depois da modelagem comportamental dos interesses núcleo e entrecortantes, o desenvolvedor pode intercambiar as visões do sistema, selecionando quais
interesses deseja visualizar em uma mesmo diagrama. A primeira configuração de visões é uma composição entre o interesse para reserva de quarto e o
interesse de registro de mensagens, a qual pode ser visualizada na figura \ref{fig:case_study_compound_1}. A ferramenta SEA/Aspect permite a seleção
de um ou mais modelos para serem compostos ao mesmo tempo, e, uma segunda configuração é apresentada na figura \ref{fig:case_study_compound_2}, com os
interesses para reserva de quarto, registr de mensagens e tratamento da lista de espera. O diagrama composto exibe um seletor de modelos na parte de
baixo, o qual permite a troca dos modelos que estão sendo compostos. As mensagens de diferentes interesses são exibidas com cores diferentes, já que
cada interesse tem uma cor associada. Esta diferenciação é importante para diferenciar quais mensagens vem de qual aspecto no modelo final.

\begin{landscape}
  \begin{figure*}[tb]
	\centering
	\includegraphics{img/case_study_compound_1.png}
	\caption{Estudo de Caso: Reserve de Quarto composta com Registro de Mensagens.}\label{fig:case_study_compound_1}
  \end{figure*}
\end{landscape}

\begin{landscape}
  \begin{figure*}[tb]
	\centering
	\includegraphics[scale=0.7]{img/case_study_compound_2.png}
	\caption{Estudo de Caso: Reserve de Quarto composta com Registro de Mensagens e Controle de Lista de Espera.}\label{fig:case_study_compound_2}
  \end{figure*}
\end{landscape}
  
\section{Estudo de Caso: Check-out de Clientes, Registro de Mensagens e Programa de Fidelidade}

O segundo estudo de caso \ldots

\section{Discussão}

A aplicação da abordagem em um estudo de caso mostra como a proposta para especificação e composição de aspectos facilita a compreensão de
sistemas orientados a aspectos, permitindo a alternância de visões, visualizando somente os interesses núcleo ou uma composição entre interesses núcleo e entrecortantes, sem esforço do
desenvolvedor. Os modelos compostos mostram o efeito dos aspectos em um sistema, com cada aspecto diferenciado por uma única cor que o representa. A
ferramenta SEA/Aspect permite a separação de interesses nas primeiras fases de desenvolvimento, o que é um dos objetivos das abordagens para modelagem
de sistemas orientados a aspectos.
